#!/bin/bash

[ $# -ne 1 ] && {
    echo "usage: $0 domain"
    exit 1
}

VM="$1"

for ((i=0 ; i<120 ; i++)) ; do
    MAC=$(virsh dumpxml "$VM" | xpath -q -e 'string(//mac/@address)' 2>/dev/null)
    IP=$(arp -n | grep $MAC | cut -d' ' -f1)

    if [ "$IP" != "" ] ; then
        break
    fi

    sleep 1
done

if [ "$IP" = "" ] ; then
    echo 1>&2 "no ip found for $VM."
    exit 1
fi

echo "$IP"
