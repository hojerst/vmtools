#!/bin/bash

##############################################################################
# functions
##############################################################################
die() {
    echo 1>&2 "ERROR:" "$@"
    exit 1
}

usage() {
    echo "usage: vmcreate name diskInGb memoryInMb numberOfCPUs"
    exit 1
}

# render a template
render() {
    TEMPLATE="$1"
    shift

    local "$@"

    eval "cat <<TEMPLATE
$(<$TEMPLATE)
TEMPLATE"
}

##############################################################################
# configuration
##############################################################################
[ -r "$HOME/.vmtools/config" ] || die "no configuration file found"
source "$HOME/.vmtools/config"

VM="$1"
DISKSIZE="${2:-20}"
MEMSIZE="${3:-1024}"
CPUS="${4:-1}"

##############################################################################
# sanity checks
##############################################################################
[ $# -lt 1 ] || [ $# -gt 4 ] && usage
[ $DISKSIZE -ge "2" ] || die "disk size must be at least 2 gb"
[ $MEMSIZE -ge "512" ] || die "memory size must be at least 512 mb"
[ $CPUS -ge 1 ] || die "need at least one cpu"
[ ! -e "/dev/$POOL/$VM" ] || die "disk for vm $VM already exists"
virsh dominfo "$VM" >/dev/null 2>&1 && die "vm $VM already exists"

##############################################################################
# work dir
##############################################################################
WORKDIR=$(mktemp -d /tmp/vmcreateXXXXXX)
trap "rm -rf -- '$WORKDIR'" EXIT

##############################################################################
# summary
##############################################################################
echo "creating vm $VM:"
echo "  memory: $MEMSIZE mb"
echo "  disk:   $DISKSIZE gb"
echo "  cpus:   $CPUS"
echo

##############################################################################
# main
##############################################################################
virsh vol-create-as --pool "$POOL" --name "$VM" --capacity "$DISKSIZE"G || die "can't create volume"
DISKPATH=$(virsh vol-path --pool "$POOL" "$VM")

virt-resize "$IMAGE" "$DISKPATH" --expand /dev/vda1 || die "can't initialize volume"
sudo virt-sysprep -a "$DISKPATH" --hostname $VM --enable hostname,random-seed || die "can't prepare system volume"

render "$HOME/.vmtools/node.xml" NAME=$VM MEMORY=$((MEMSIZE*1024)) VCPUS=$CPUS >$WORKDIR/node.xml

virsh define "$WORKDIR/node.xml"
virsh start "$VM"
virsh autostart "$VM"

echo "IP: $(vmip "$VM")"
