#!/bin/bash

if [ $# -ne 1 ] ; then
    echo "usage: $(basename $0) vmname"
    exit 1
fi

###########################################################################
# configuration
###########################################################################
VM=$1
POOL=vmdata
TARGETDIR="$HOME/.vmtools/images"
TARGETIMAGE="$TARGETDIR/${VM}.img"

###########################################################################
# functions
###########################################################################
die() {
    echo 1>&2 "ERROR:" "$@"
    exit 1
}

###########################################################################
# sanity checks
###########################################################################

[ $UID -eq 0 ] || die "this script should be run as root"
[ ! -e $TARGETIMAGE ] || die "$TARGETIMAGE already exists"

[ "$(virsh domstate "$VM")" == "shut off" ] || die "vm $VM needs to be powered off. (run: virsh shutdown $VM)"

# find path for volume
SOURCEDISK=$(virsh vol-path --pool "$POOL" "$VM")
[ -r "$SOURCEDISK" ] || die "source disk $SOURCEDISK is not readable."

###########################################################################
# work dir
###########################################################################
WORKDIR=$(mktemp -d /tmp/vmpackageXXXXXX)
trap "rm -rf -- '$WORKDIR'" EXIT

###########################################################################
# main
###########################################################################

mkdir -p "$TARGETDIR"

echo "creating image from source disk"
qemu-img convert "$SOURCEDISK" "$WORKDIR/disk.img" -O qcow2

echo "preparing system for distribution"
virt-sysprep -a "$WORKDIR/disk.img"

echo "creating compressed sparse image"
virt-sparsify "$WORKDIR/disk.img" "$TARGETIMAGE" --compress
