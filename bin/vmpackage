#!/bin/bash

##############################################################################
# configuration
##############################################################################
VM=${1:-base}
POOL=vmdata
TARGETDIR="$HOME"

##############################################################################
# functions
##############################################################################
die() {
    echo 1>&2 "ERROR:" "$@"
    exit 1
}

##############################################################################
# sanity checks
##############################################################################

# find path for volume
SOURCEDISK=$(virsh vol-path --pool "$POOL" "$VM")

[ "$(virsh domstate "$VM")" == "shut off" ] || die "vm $VM needs to be powered off. (run: virsh shutdown $VM)"
[ -r "$SOURCEDISK" ] || die "source disk $SOURCEDISK is not readable."

##############################################################################
# work dir
##############################################################################
WORKDIR=$(mktemp -d /tmp/vmpackageXXXXXX)
trap "rm -rf -- '$WORKDIR'" EXIT

##############################################################################
# main
##############################################################################

# copy source disk
qemu-img convert "$SOURCEDISK" "$WORKDIR/disk.img" -O qcow2

# cleanup disk image (prepare clonable image)
sudo virt-sysprep -a "$WORKDIR/disk.img"

# create script which runs on first boot
cat >"$WORKDIR/firstboot" <<EOF
#!/bin/sh

dpkg-reconfigure openssh-server
apt-get update
apt-get dist-upgrade -y

rm /etc/init.d/firstboot
rm /etc/rc?.d/S99firstboot
EOF
virt-copy-in -a "$WORKDIR/disk.img" "$WORKDIR/firstboot" /etc/init.d || die "can't create firstboot script"

guestfish -a "$WORKDIR/disk.img" <<EOF
run
mount /dev/vda1 /
chmod 0755 /etc/init.d/firstboot
ln-s ../init.d/firstboot /etc/rc1.d/S99firstboot
ln-s ../init.d/firstboot /etc/rc2.d/S99firstboot
ln-s ../init.d/firstboot /etc/rc3.d/S99firstboot
ln-s ../init.d/firstboot /etc/rc4.d/S99firstboot
ln-s ../init.d/firstboot /etc/rc5.d/S99firstboot
ln-s ../init.d/firstboot /etc/rc6.d/S99firstboot
ln-s ../init.d/firstboot /etc/rcS.d/S99firstboot
EOF

# create sparse image of disk
virt-sparsify "$WORKDIR/disk.img" "$WORKDIR/sparse.img"

# create compressed image
qemu-img convert "$WORKDIR/sparse.img" "$TARGETDIR/$VM.img" -O qcow2 -c
